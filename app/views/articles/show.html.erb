<div class="container mt-4 mb-4">

  <% provide :title, "記事詳細｜#{@article.title}" %>
  
  <%# --- 記事本文：カード化 --- %>
  <div class="card mb-4">
    <div class="card-body">
      <%= render @article %>
    </div>
  </div>

  <%# --- コメント見出し（件数バッジ） --- %>
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="h5 mb-0">
      コメント <span class="badge bg-secondary"><%= @article.comments.count %></span>
    </h2>
  </div>

  <%# --- コメント一覧：最新→古い順、List Group で整列 --- %>
  <% if @article.comments.any? %>
    <ul class="list-group mb-4">
      <% @article.comments.order(created_at: :desc).each do |comment| %>
        <li class="list-group-item">
          <div class="d-flex justify-content-between gap-3">
            <div class="flex-grow-1">
              <strong><%= comment.commenter.presence || '匿名さん' %></strong>
              <small class="text-muted ms-2"><%= l comment.created_at, format: :short %></small>
              <div class="mt-1"><%= simple_format(h(comment.body)) %></div>
            </div>
            <div class="text-nowrap">
              <%= link_to "削除", [comment.article, comment],
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                  class: "btn btn-sm btn-outline-danger" %>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
  <% else %>
    <div class="alert alert-light border mb-4">まだコメントはありません。最初のコメントを投稿しましょう。</div>
  <% end %>

  <%# --- コメント投稿フォーム：カード化 --- %>
  <div class="card mb-4">
    <div class="card-header">新しいコメント</div>
    <div class="card-body">

      <%# ▼ バリデーションエラー表示 %>
      <% if @comment && @comment.errors.any? %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>入力エラーがあります：</strong>
          <ul class="mb-0">
            <% @comment.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% end %>

      <%= form_with(model: [@article, @comment]) do |f| %>
        <div class="mb-3">
          <%= f.label :commenter, "お名前", class: "form-label" %>
          <%= f.text_field :commenter, class: "form-control", placeholder: "例）山田太郎" %>
        </div>
        <div class="mb-3">
          <%= f.label :body, "コメント", class: "form-label" %>
          <%= f.text_area :body, rows: 4, class: "form-control", placeholder: "本文を入力" %>
        </div>
        <%= f.submit "コメントする", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <%# --- 下部アクション：ボタン整列・配色統一 --- %>
  <div class="d-flex gap-2">
    <%= link_to "この投稿を編集する", edit_article_path(@article), class: "btn btn-outline-secondary" %>
    <%= link_to "一覧に戻る", articles_path, class: "btn btn-outline-secondary" %>
    <%= button_to "この記事を削除", @article,
          method: :delete,
          data: { turbo_confirm: "本当に削除しますか？" },
          class: "btn btn-outline-danger ms-auto" %>
  </div>
</div>

